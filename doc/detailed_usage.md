作者：张蛋蛋
链接：https://www.zhihu.com/question/333086833/answer/841650555
来源：知乎
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

本项目仅限于程序员或者计算机深度爱好者测试使用，请电脑小白请不要尝试，某些人弄个amd显卡的电脑运行，然后私信说跑不起来，每个星期都有这样的私信，一检查要不是没有独显，要不就是amd的gpu。这个脚本是有python编写，一般的报错信息都可以通过百度查询错误信息得到解决方案。如果你连ImportError: No module named Image错误都解决不了就不要私信。泻药，干货来了传统的图片去水印方法虽然效率高，但是对细节破坏的比较严重。去水印说简单也简单，说难也难。有的水印用修复图章几秒钟搞定，有的水印要一两个钟头还不一定能搞定。一些细节不是很丰富的图片，可以通过photoshop等图像处理软件进行临近像素填充，掩盖水印部分，可以达到接近完美的效果。<img src="https://pic2.zhimg.com/50/v2-37061814ffd73b13b3be8b1cb816c8ab_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1384" data-rawheight="537" data-default-watermark-src="https://pic2.zhimg.com/50/v2-29939c2ba1d8828ac58adbdb437f3221_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="1384" data-original="https://pic2.zhimg.com/v2-37061814ffd73b13b3be8b1cb816c8ab_r.jpg?source=1940ef5c"/>面对一些细节极其复杂的图像，ps已经不能很完美了。面对细节丰富且复杂的水印，传统的ps去水印方法已经不能满足需求啊。现在，用AI技术，去除水印，可以达到几乎完美了。随着人工智障技术的不断发展，深度学习其在图像处理领域的应用越来越广泛在了，ICML2018上,英伟达和MIT等机构的研究人员展示了一项图像降燥技术Noise2Noise,能够自动去除图片中的水印、模糊等噪音,几乎能完美复原,而且渲染时间是毫秒级。论文 Noise2Noise: Learning Image Restoration without Clean Data 第三方复现项目：yu4u/noise2noise 这个可以用来去字幕和图像噪点，但是作者并没有添加去水印的功能。我对这个python脚本进行了修改，已经可以去水印了。githubhttps://github.com/zxq2233/n2n-watermark-remove​github.com下面教你们怎么用，下面的虽然很长，却很死，只要按照步骤来，一点都不难。必须是装有英伟达系列显卡的电脑才能运行！！！答主在这里声明:本教程仅供参考，不赞成也不鼓励大家用来盗图。答主在这里声明:本教程仅供参考，不赞成也不鼓励大家用来盗图。答主在这里声明:本教程仅供参考，不赞成也不鼓励大家用来盗图。1.下载脚本  下载以后把后缀名后面的.bin去掉。后缀改成zip即可解压n2n-watermark-remove-数据集-阿里云天池​tianchi.aliyun.com首先进去点击下载文件，然后你会得到一个zip格式的压缩包。把这个压缩包里面的n2n-watermark-remove-master文件解压到桌面<img src="https://pic2.zhimg.com/50/v2-181f3bb5597eec09926e044e4716d8df_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="256" data-rawheight="237" data-default-watermark-src="https://pic1.zhimg.com/50/v2-b5f66d2b09c190dd3eb4c5c2bc3edad3_hd.jpg?source=1940ef5c" class="content_image" width="256"/>2.搭建运行环境。首先去英伟达官网下载您的计算机显卡对应的显卡驱动最新版本。（studio版-设计师PS 建模作图用  GRD版-打游戏用）NVIDIA 驱动程序下载​www.nvidia.cn很多人使用的是老版本的显卡驱动，cuda版本过低，tf框架跑起来报错的安装完成重启电脑，桌面右键点击NVIDIA控制面板,系统信息—>组件<img src="https://pic2.zhimg.com/50/v2-be5edc86ae0fc167cc332085f2e10b58_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="948" data-rawheight="417" data-default-watermark-src="https://pic4.zhimg.com/50/v2-8f028170051c8567abb2f23ec28e274b_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="948" data-original="https://pic2.zhimg.com/v2-be5edc86ae0fc167cc332085f2e10b58_r.jpg?source=1940ef5c"/><img src="https://pic2.zhimg.com/50/v2-524fe802d457da743d16a95e7ec6fda1_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="756" data-rawheight="660" data-default-watermark-src="https://pic1.zhimg.com/50/v2-c957a36a5ca44212af277e26a66b61e8_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="756" data-original="https://pic2.zhimg.com/v2-524fe802d457da743d16a95e7ec6fda1_r.jpg?source=1940ef5c"/>看看cuda版本是不是大于9.0，低于9.0会报错。如果安装之后还是低于9.0，使用软件管家之类的软件卸载了电脑里所有NVIDIA开头的软件，然后再通过上方的地址重新下载最新版的显卡驱动安装。然后搭建python运行容器。不用去python官网下载软件包，太麻烦，推荐使用Miniconda，一键化傻瓜安装。为了照顾新手，我这里推荐使用Miniconda3-4.5.4，这个不是最新版，你们也不要去官网下载最新版，tensorflow-gpu版本需要与cuda/cudnn版本匹配，否则脚本跑起来报错。Miniconda3-4.5.4下载地址：https://mirrors.tuna.tsinghua.edu.cn/anaconda/miniconda/Miniconda3-4.5.4-Windows-x86_64.exe 备用下载  代码托管 下载Miniconda3-4.5.4-Windows-x86_64.exe并安装。连续点击next，直到安装完成，安装目录随意<img src="https://pic4.zhimg.com/50/v2-35c19d091d9408241736f309a6679767_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="791" data-rawheight="592" data-default-watermark-src="https://pic4.zhimg.com/50/v2-a404e0bdb3904b6e56666e7299e1c836_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="791" data-original="https://pic3.zhimg.com/v2-35c19d091d9408241736f309a6679767_r.jpg?source=1940ef5c"/><img src="https://pic2.zhimg.com/50/v2-698d3e049783b0ac85e686b7536302e2_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="585" data-rawheight="478" data-default-watermark-src="https://pic2.zhimg.com/50/v2-c58bf563b864a5191a2085464f3ca2e4_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="585" data-original="https://pic4.zhimg.com/v2-698d3e049783b0ac85e686b7536302e2_r.jpg?source=1940ef5c"/><img src="https://pic4.zhimg.com/50/v2-08f41707311f5c805dcec907f058ff0d_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="585" data-rawheight="478" data-default-watermark-src="https://pic1.zhimg.com/50/v2-643485184c7e7565e1ed1825e35a4a01_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="585" data-original="https://pic4.zhimg.com/v2-08f41707311f5c805dcec907f058ff0d_r.jpg?source=1940ef5c"/><img src="https://pic4.zhimg.com/50/v2-ec54bb629480ebdb9db45c580cac5518_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="585" data-rawheight="478" data-default-watermark-src="https://pic1.zhimg.com/50/v2-1f3912289da7c874f332576585e5f985_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="585" data-original="https://pic1.zhimg.com/v2-ec54bb629480ebdb9db45c580cac5518_r.jpg?source=1940ef5c"/><img src="https://pic3.zhimg.com/50/v2-5e941ed69a91a3e64b19299a5654decf_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="585" data-rawheight="478" data-default-watermark-src="https://pic4.zhimg.com/50/v2-df6d43c52616f579f8cf42a1ee310f75_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="585" data-original="https://pic1.zhimg.com/v2-5e941ed69a91a3e64b19299a5654decf_r.jpg?source=1940ef5c"/><img src="https://pic1.zhimg.com/50/v2-39e0bd64c9e87c1655d143603c8bcb1b_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="585" data-rawheight="478" data-default-watermark-src="https://pic4.zhimg.com/50/v2-6ff59bccca506dc03832d19344809497_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="585" data-original="https://pic1.zhimg.com/v2-39e0bd64c9e87c1655d143603c8bcb1b_r.jpg?source=1940ef5c"/><img src="https://pic1.zhimg.com/50/v2-760691df9c2ec7256e1b65ad85d645f7_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="585" data-rawheight="478" data-default-watermark-src="https://pic1.zhimg.com/50/v2-c440c03e86740f9e5fc7459c00e348ca_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="585" data-original="https://pic1.zhimg.com/v2-760691df9c2ec7256e1b65ad85d645f7_r.jpg?source=1940ef5c"/>安装好了。可以在开始菜单找到一个Anaconda Prompt的应用。打开<img src="https://pic4.zhimg.com/50/v2-4424b2d08dbf75fb74abf57a07d4c650_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="399" data-rawheight="111" data-default-watermark-src="https://pic1.zhimg.com/50/v2-6f2b81ca1686224f58a2d7b997bb4f7c_hd.jpg?source=1940ef5c" class="content_image" width="399"/><img src="https://pic3.zhimg.com/50/v2-6a8bca2b2d0708488e3db709a92999bd_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1239" data-rawheight="646" data-default-watermark-src="https://pic4.zhimg.com/50/v2-9a498ba8c24fa48bfc44b49befab3561_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="1239" data-original="https://pic4.zhimg.com/v2-6a8bca2b2d0708488e3db709a92999bd_r.jpg?source=1940ef5c"/>然后复制下面三行，粘贴到Anaconda Prompt中，conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/
conda config --set show_channel_urls yes<img src="https://pic1.zhimg.com/50/v2-78ed7815d5636970e000b4d21064a7c7_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1231" data-rawheight="646" data-default-watermark-src="https://pic1.zhimg.com/50/v2-61eec31f8492968ddc2f1b20795c8113_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="1231" data-original="https://pic1.zhimg.com/v2-78ed7815d5636970e000b4d21064a7c7_r.jpg?source=1940ef5c"/>然后按两次回车然后再复制这一行conda install tensorflow-gpu==1.9回车，然后界面上一直有文字滚动。不用管它。<img src="https://pic2.zhimg.com/50/v2-39f9ea893a9f686d83e4e0037948bdf8_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1239" data-rawheight="639" data-default-watermark-src="https://pic2.zhimg.com/50/v2-ef71fe501d4edbb29d88adeeb7deebc4_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="1239" data-original="https://pic4.zhimg.com/v2-39f9ea893a9f686d83e4e0037948bdf8_r.jpg?source=1940ef5c"/>等出现Proceed ([y]/n)?的时候输入y，然后回车，然后又是一阵文字滚动。。。。等它滚完<img src="https://pic1.zhimg.com/50/v2-f9be81cf2c326576c60fed12d7b66189_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1223" data-rawheight="638" data-default-watermark-src="https://pic2.zhimg.com/50/v2-40e8bed66797f1f0355c55b3365d3ca7_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="1223" data-original="https://pic2.zhimg.com/v2-f9be81cf2c326576c60fed12d7b66189_r.jpg?source=1940ef5c"/>等到有三行done的时候，可以关闭Anaconda Prompt。<img src="https://pic2.zhimg.com/50/v2-ecf39669a00fdf5675365897d7c853f5_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1235" data-rawheight="123" class="origin_image zh-lightbox-thumb" width="1235" data-original="https://pic4.zhimg.com/v2-ecf39669a00fdf5675365897d7c853f5_r.jpg?source=1940ef5c"/>3.准备数据集下载coco2017数据集，下载地址 http://images.cocodataset.org/zips/val2017.zip如果下载慢可以从这个压缩包可以解压出5000张图片，其中4200张用来训练。剩下的800张用于测试<img src="https://pic4.zhimg.com/50/v2-8038a8b2d64cae4abcbf5bd7e0a22fcc_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1919" data-rawheight="1024" data-default-watermark-src="https://pic1.zhimg.com/50/v2-6724a7f3fedaeecca4cd39a7b185510c_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="1919" data-original="https://pic4.zhimg.com/v2-8038a8b2d64cae4abcbf5bd7e0a22fcc_r.jpg?source=1940ef5c"/>打开我们刚刚解压到桌面的n2n-watermark-remove-master目录，进入里面的dataset，再进入train，使用windows自带的文件管理器随便框选其中800张图片，右键剪切，移动到test目录。剩下的4200张（ctrl+A）全选选中移动到train目录里。<img src="https://pic1.zhimg.com/50/v2-01fd037f80f70f383362254a6f549663_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="644" data-rawheight="382" data-default-watermark-src="https://pic1.zhimg.com/50/v2-176959fb4a954a0e2e5f6e79aa6f7fb0_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="644" data-original="https://pic4.zhimg.com/v2-01fd037f80f70f383362254a6f549663_r.jpg?source=1940ef5c"/><img src="https://pic1.zhimg.com/50/v2-52930784b4e922db9cd7ef71c133b498_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="398" data-rawheight="225" data-default-watermark-src="https://pic1.zhimg.com/50/v2-02a46f018018cc4306e8f4b3ad270c6e_hd.jpg?source=1940ef5c" class="content_image" width="398"/>然后返回桌面4.获取/制作水印这一步是非常重要的，想要计算机去水印，就要教计算机分辨水印，只有计算机学会了分辨一张有水印的图像中那些部分是水印，哪些部分不是水印，才能去水印。这一步最关键的就是找到水印原图。一般LOGO做的水印，一般可以在其网站找到LOGO图像，(如果是白底需要抠图)，当然你也可以用聪明一点都办法，假设某个网站上的图片都有统一样式的水印，你只需要去这个网站上传一张纯色背景的图片(推荐50%中性灰)，让系统为这张图片加上水印，然后通过图像减法计算出差值，也就得到了水印图像。如果网上找不到相关水印就需要自己制作，制作水印可以看这两个教程，https://www.bilibili.com/video/av58901808​www.bilibili.comhttps://www.bilibili.com/video/av58550738​www.bilibili.com当然n2n-watermark-remove目录里已经包含了测试用的的模型和水印。获得水印之后使用photoshop等软件新建一个800X800px图像，将水印密密麻麻的拼到这张图上，保存并命名为1.png。背景需要透明<img src="https://pic1.zhimg.com/50/v2-58378c81fd31bc95d6769ec11f3552dd_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1402" data-rawheight="817" data-default-watermark-src="https://pic2.zhimg.com/50/v2-b1fc945987442202eaecec446465ea3d_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="1402" data-original="https://pic1.zhimg.com/v2-58378c81fd31bc95d6769ec11f3552dd_r.jpg?source=1940ef5c"/>把1.png替换掉n2n-watermark-remove目录下1.png。此方法只能去除固定大小不固定位置的水印（训练的水印必须与水印图像上的水印一样大）如果您要去除的水印形状颜色或大小有随机变化，那么需要修改代码。参考 https://github.com/yu4u/noise2noise/blob/master/noise_model.py#L29修改脚本让水印产生随机变化。5.训练去水印打开Anaconda Prompt输入 cd加一个空格    然后鼠标选中n2n-watermark-remove目录，拉到Anaconda Prompt界面上，这样就能自动添加路径。按回车，具体看视频。然后输入下面命令，按回车，接着屏幕又是一阵文字滚动。等它滚完。pip install -r requirements.txt然后执行训练命令python train.py --image_dir dataset/train --test_dir dataset/test --image_size 128 --batch_size 8 --lr 0.001 --source_noise_model text,0,50 --target_noise_model text,0,50 --val_noise_model text,25,25 --loss mae --output_path text_noise训练时间由显卡决定。一般几十个小时到几百个小时不等，办公电脑就不用试了。有条件的可以用Kaggle和Google Colab训练过程中,每迭代一圈就会生成一个weights.xxxxx-xxxx.hdf5模型文件。并不是每次都会生成hdf5文件，有些时候不生成属于正常现象。<img src="https://pic1.zhimg.com/50/v2-cd05ead7ddb8d5861675e281f5b27bd6_hd.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="784" data-rawheight="700" data-default-watermark-src="https://pic2.zhimg.com/50/v2-8bdd47a84f4700cb7c423a0677835090_hd.jpg?source=1940ef5c" class="origin_image zh-lightbox-thumb" width="784" data-original="https://pic2.zhimg.com/v2-cd05ead7ddb8d5861675e281f5b27bd6_r.jpg?source=1940ef5c"/>开头的数字代表圈数。数字越大，去水印效果越好，这个脚本默认跑100圈。，一般跑50圈左右就可以关闭窗口停止了，然后生成的模型去水印。6.利用水印模型去水印得到模型以后就可以用用来去水印了使用这个命令python test_model.py --weight_file 水印模型文件名.hdf5  --image_dir inputdir --output_dir outputdir水印模型文件名.hdf5替换成实际的文件名，inputdir里放入有水印的图片，执行命令。去除水印后的图片会静静的躺在 outputdir目录里。视频里演示的效果可能有些不干净，因为这是短时间内训练的结果，理论上训练 30 小时以上就可以达到基本可用程度。，想要水印去的干净，训练时间不能少。